// Test #04. Change signature provider (from owner or current provider). 

"test-00-header.fif" include


"EQAWYHnDf8qmG9mC1CGD1Svf9_9OjWpDgL9EU2fgsTrfH5jG" dup =: owner_address $>smca 0= abort"bad address"
=: owner_flags
=: owner_addr
=: owner_wc

"EQART9XH37phxxDoNGmcKc7t9AS4iR76HPj2Oj0dgSY824RZ" dup =: other_address $>smca 0= abort"bad address"
=: other_flags
=: other_addr
=: other_wc

"EQDK-Qt00761ArsHAK5MevbckLBxyHMmjpUEJ4cHWMKOYsZB" dup =: provider_address $>smca 0= abort"bad address"
=: provider_flags
=: provider_addr
=: provider_wc

"EQCv4tjf-7E9V42WMlRYVPsHtjfiMv3l3-jk4CyE8dz5ReFi" dup =: new_provider_address $>smca 0= abort"bad address"
=: new_provider_flags
=: new_provider_addr
=: new_provider_wc


<b
   b{100} s, owner_wc 8 i, owner_addr 256 u, // owner address
   7 64 u,        // next_item_index
   <b b> ref,     // content
   <b b> ref,     // nft_item_code
   <b b> ref,     // royalty_params
   <b
      10 8 u,     // sign_max_number
      0 8 u,      // sign_number
      1 Gram,     // sign_deploy_fee
      6 Gram,     // sign_commit_fee
      8 Gram,     // min_stake
      b{100} s, provider_wc 8 i, provider_addr 256 u, // sign_provider_address
      sign_request_code s>c ref,     // sign_request_code
      dictnew dict,  // signatures
   b> ref,
b> =: init_state


<b
   0x14E 32 u,   // op code
   0 64 u,   // query_id
   // new provider address
   b{100} s,
   new_provider_wc 8 i,
   new_provider_addr 256 u,
b> <s =: in_msg_body


// ------------------------ Case 1: wrong sender ----------------------

<b 
   // flags: int_msg_info, ihr_disabled, bounce, bounced
   b{0100} s,

   // sender address
   b{100} s,
   other_wc 8 i,
   other_addr 256 u,
b> =: in_msg_full


in_msg_full
in_msg_body
recv_internal 
code
init_state
c7 
runvmctx 

=: state
=: exit_code

exit_code 400 "Wrong exit code" ASSERT_EQUAL_INTS


// ------------------------ Case 2: sender == owner ----------------------

<b
   // flags: int_msg_info, ihr_disabled, bounce, bounced
   b{0100} s,

   // sender address
   b{100} s,
   owner_wc 8 i,
   owner_addr 256 u,
b> =: in_msg_full


in_msg_full
in_msg_body
recv_internal 
code
init_state
c7 
runvmctx 

=: state
=: exit_code

exit_code 0 "Wrong exit code" ASSERT_EQUAL_INTS

// parse state (skip nft general contents)
state <s
3 u@+ swap drop 8 u@+ swap drop 256 u@+ swap drop 64 u@+ swap drop swap drop
ref@+ drop ref@+ drop ref@+ drop ref@+ <s =: stored_signature_params =: stored_slice
stored_slice s>

// bytes
stored_signature_params 8 u@+ =: stored_signature_params =: stored_sign_max_number
stored_signature_params 8 u@+ =: stored_signature_params =: stored_sign_number
stored_signature_params 4 u@+ =: stored_signature_params =: stored_sign_deploy_fee_len
stored_signature_params stored_sign_deploy_fee_len 8 * u@+ =: stored_signature_params =: stored_sign_deploy_fee
stored_signature_params 4 u@+ =: stored_signature_params =: stored_sign_commit_fee_len
stored_signature_params stored_sign_commit_fee_len 8 * u@+ =: stored_signature_params =: stored_sign_commit_fee
stored_signature_params 4 u@+ =: stored_signature_params =: stored_min_stake_len
stored_signature_params stored_min_stake_len 8 * u@+ =: stored_signature_params =: stored_min_stake
stored_signature_params 3 u@+ =: stored_signature_params =: stored_provider_flags
stored_signature_params 8 u@+ =: stored_signature_params =: stored_provider_wc
stored_signature_params 256 u@+ =: stored_signature_params =: stored_provider_addr
stored_signature_params 1 u@+ =: stored_signature_params =: stored_dict_bits

// refs
stored_signature_params ref@+ =: stored_sign_request_code =: stored_signature_params
stored_signature_params s>

// assert contents

stored_sign_max_number 10 "Wrong stored_sign_max_number" ASSERT_EQUAL_INTS
stored_sign_number 0 "Wrong stored_sign_number" ASSERT_EQUAL_INTS
stored_sign_deploy_fee 1 "Wrong stored_sign_deploy_fee" ASSERT_EQUAL_INTS
stored_sign_commit_fee 6 "Wrong stored_sign_commit_fee" ASSERT_EQUAL_INTS
stored_min_stake 8 "Wrong stored_min_stake" ASSERT_EQUAL_INTS

<b b{100} s, stored_provider_wc 8 i, stored_provider_addr 256 u, b> boc>B  // stored provider
<b b{100} s, new_provider_wc 8 i, new_provider_addr 256 u, b> boc>B        // new provider
"Wrong bytes" ASSERT_EQUAL_BYTES

stored_dict_bits 0 "Wrong stored_dict_bits" ASSERT_EQUAL_INTS  // no signatures

sign_request_code s>c boc>B 
stored_sign_request_code boc>B 
"Wrong bytes" ASSERT_EQUAL_BYTES


// ------------------------ Case 3: sender == provider ----------------------

<b
   // flags: int_msg_info, ihr_disabled, bounce, bounced
   b{0100} s,

   // sender address
   b{100} s,
   provider_wc 8 i,
   provider_addr 256 u,
b> =: in_msg_full


in_msg_full
in_msg_body
recv_internal 
code
init_state
c7 
runvmctx 

=: state
=: exit_code

exit_code 0 "Wrong exit code" ASSERT_EQUAL_INTS

// parse state (skip nft general contents)
state <s
3 u@+ swap drop 8 u@+ swap drop 256 u@+ swap drop 64 u@+ swap drop swap drop
ref@+ drop ref@+ drop ref@+ drop ref@+ <s =: stored_signature_params =: stored_slice
stored_slice s>

// bytes
stored_signature_params 8 u@+ =: stored_signature_params =: stored_sign_max_number
stored_signature_params 8 u@+ =: stored_signature_params =: stored_sign_number
stored_signature_params 4 u@+ =: stored_signature_params =: stored_sign_deploy_fee_len
stored_signature_params stored_sign_deploy_fee_len 8 * u@+ =: stored_signature_params =: stored_sign_deploy_fee
stored_signature_params 4 u@+ =: stored_signature_params =: stored_sign_commit_fee_len
stored_signature_params stored_sign_commit_fee_len 8 * u@+ =: stored_signature_params =: stored_sign_commit_fee
stored_signature_params 4 u@+ =: stored_signature_params =: stored_min_stake_len
stored_signature_params stored_min_stake_len 8 * u@+ =: stored_signature_params =: stored_min_stake
stored_signature_params 3 u@+ =: stored_signature_params =: stored_provider_flags
stored_signature_params 8 u@+ =: stored_signature_params =: stored_provider_wc
stored_signature_params 256 u@+ =: stored_signature_params =: stored_provider_addr
stored_signature_params 1 u@+ =: stored_signature_params =: stored_dict_bits

// refs
stored_signature_params ref@+ =: stored_sign_request_code =: stored_signature_params
stored_signature_params s>

// assert contents

stored_sign_max_number 10 "Wrong stored_sign_max_number" ASSERT_EQUAL_INTS
stored_sign_number 0 "Wrong stored_sign_number" ASSERT_EQUAL_INTS
stored_sign_deploy_fee 1 "Wrong stored_sign_deploy_fee" ASSERT_EQUAL_INTS
stored_sign_commit_fee 6 "Wrong stored_sign_commit_fee" ASSERT_EQUAL_INTS
stored_min_stake 8 "Wrong stored_min_stake" ASSERT_EQUAL_INTS

<b b{100} s, stored_provider_wc 8 i, stored_provider_addr 256 u, b> boc>B  // stored provider
<b b{100} s, new_provider_wc 8 i, new_provider_addr 256 u, b> boc>B        // new provider
"Wrong bytes" ASSERT_EQUAL_BYTES

stored_dict_bits 0 "Wrong stored_dict_bits" ASSERT_EQUAL_INTS  // no signatures

sign_request_code s>c boc>B 
stored_sign_request_code boc>B 
"Wrong bytes" ASSERT_EQUAL_BYTES