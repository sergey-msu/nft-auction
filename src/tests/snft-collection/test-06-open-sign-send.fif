// Test #06. Open sign request: send message to request smc.


"test-00-header.fif" include

// 'https://pics.com/pdurovsign.png' - sign content
"aHR0cHM6Ly9waWNzLmNvbS9wZHVyb3ZzaWduLnBuZw==" =: content

"EQAWYHnDf8qmG9mC1CGD1Svf9_9OjWpDgL9EU2fgsTrfH5jG" dup =: owner_address $>smca 0= abort"bad address"
=: owner_flags
=: owner_addr
=: owner_wc

"EQDK-Qt00761ArsHAK5MevbckLBxyHMmjpUEJ4cHWMKOYsZB" dup =: provider_address $>smca 0= abort"bad address"
=: provider_flags
=: provider_addr
=: provider_wc

"EQCv4tjf-7E9V42WMlRYVPsHtjfiMv3l3-jk4CyE8dz5ReFi" dup =: signee_address $>smca 0= abort"bad address"
=: signee_flags
=: signee_addr
=: signee_wc


<b
   b{100} s, owner_wc 8 i, owner_addr 256 u, // owner address
   7 64 u,        // next_item_index
   <b b> ref,     // content
   <b b> ref,     // nft_item_code
   <b b> ref,     // royalty_params
   <b
      10 8 u,           // sign_max_number
      0 8 u,            // sign_number
       500000000 Gram,  // sign_deploy_fee
      1500000000 Gram,  // sign_commit_fee
      9000000000 Gram,  // min_stake
      b{100} s, provider_wc 8 i, provider_addr 256 u, // sign_provider_address
      sign_request_code s>c ref, // sign_request_code
      dictnew dict,     // signatures
   b> ref,
b> =: init_state


// ------------------------ Case 1: send message OK - from owner ----------------------

<b
   // flags: int_msg_info, ihr_disabled, bounce, bounced
   b{0100} s,

   // sender address
   b{100} s, owner_wc 8 i, owner_addr 256 u,
b> =: in_msg_full

<b
   0x6C 32 u,   // op code
   0 64 u,      // query_id
   b{100} s, signee_wc 8 i, signee_addr 256 u, // wanted signee address
   11150000000 Gram, // ton amount to pass to request (2 + 9 + 0.05 + 0.1)
   1 16 u,      // network id
   12345 96 u,  // network address
   <b  // content
      0x01 8 u, // offchain prefix 
      content base64>B B, // content URI
   b> ref,
b> <s =: in_msg_body


in_msg_full
in_msg_body
recv_internal 
code
init_state
c7
runvmctx 

=: state
=: exit_code

exit_code 0 "Wrong exit code" ASSERT_EQUAL_INTS

// parse state (skip nft general contents)
state <s
3 u@+ swap drop 8 u@+ swap drop 256 u@+ swap drop 64 u@+ swap drop swap drop
ref@+ drop ref@+ drop ref@+ drop ref@+ <s =: stored_signature_params =: stored_slice
stored_slice s>

// bytes
stored_signature_params 8 u@+ =: stored_signature_params =: stored_sign_max_number
stored_signature_params 8 u@+ =: stored_signature_params =: stored_sign_number
stored_signature_params 4 u@+ =: stored_signature_params =: stored_sign_deploy_fee_len
stored_signature_params stored_sign_deploy_fee_len 8 * u@+ =: stored_signature_params =: stored_sign_deploy_fee
stored_signature_params 4 u@+ =: stored_signature_params =: stored_sign_commit_fee_len
stored_signature_params stored_sign_commit_fee_len 8 * u@+ =: stored_signature_params =: stored_sign_commit_fee
stored_signature_params 4 u@+ =: stored_signature_params =: stored_min_stake_len
stored_signature_params stored_min_stake_len 8 * u@+ =: stored_signature_params =: stored_min_stake
stored_signature_params 3 u@+ =: stored_signature_params =: stored_provider_flags
stored_signature_params 8 u@+ =: stored_signature_params =: stored_provider_wc
stored_signature_params 256 u@+ =: stored_signature_params =: stored_provider_addr
stored_signature_params 1 u@+ =: stored_signature_params =: stored_dict_bits

// refs
stored_signature_params ref@+ =: stored_sign_request_code =: stored_signature_params
stored_signature_params s>

// assert contents

stored_sign_max_number 10 "Wrong stored_sign_max_number" ASSERT_EQUAL_INTS
stored_sign_number 0 "Wrong stored_sign_number" ASSERT_EQUAL_INTS
stored_sign_deploy_fee  500000000 "Wrong stored_sign_deploy_fee" ASSERT_EQUAL_INTS
stored_sign_commit_fee 1500000000 "Wrong stored_sign_commit_fee" ASSERT_EQUAL_INTS
stored_min_stake 9000000000 "Wrong stored_min_stake" ASSERT_EQUAL_INTS

<b b{100} s, stored_provider_wc 8 i, stored_provider_addr 256 u, b> boc>B  // stored provider
<b b{100} s, provider_wc 8 i, provider_addr 256 u, b> boc>B        // new provider
"Wrong bytes" ASSERT_EQUAL_BYTES

stored_dict_bits 0 "Wrong stored_dict_bits" ASSERT_EQUAL_INTS  // no signatures

stored_sign_request_code boc>B
sign_request_code s>c boc>B
"Wrong bytes" ASSERT_EQUAL_BYTES


// ------------------------ Case 2: send message OK - from provider ----------------------

<b
   // flags: int_msg_info, ihr_disabled, bounce, bounced
   b{0100} s,

   // sender address
   b{100} s, provider_wc 8 i, provider_addr 256 u,
b> =: in_msg_full

<b
   0x6C 32 u,   // op code
   0 64 u,      // query_id
   b{100} s, signee_wc 8 i, signee_addr 256 u, // wanted signee address
   11150000000 Gram, // ton amount to pass to request (2 + 9 + 0.05 + 0.1)
   1 16 u,      // network id
   12345 96 u,  // network address
   <b  // content
      0x01 8 u, // offchain prefix 
      content base64>B B, // content URI
   b> ref,
b> <s =: in_msg_body


in_msg_full
in_msg_body
recv_internal 
code
init_state
c7
runvmctx 

=: state
=: exit_code

exit_code 0 "Wrong exit code" ASSERT_EQUAL_INTS

// parse state (skip nft general contents)
state <s
3 u@+ swap drop 8 u@+ swap drop 256 u@+ swap drop 64 u@+ swap drop swap drop
ref@+ drop ref@+ drop ref@+ drop ref@+ <s =: stored_signature_params =: stored_slice
stored_slice s>

// bytes
stored_signature_params 8 u@+ =: stored_signature_params =: stored_sign_max_number
stored_signature_params 8 u@+ =: stored_signature_params =: stored_sign_number
stored_signature_params 4 u@+ =: stored_signature_params =: stored_sign_deploy_fee_len
stored_signature_params stored_sign_deploy_fee_len 8 * u@+ =: stored_signature_params =: stored_sign_deploy_fee
stored_signature_params 4 u@+ =: stored_signature_params =: stored_sign_commit_fee_len
stored_signature_params stored_sign_commit_fee_len 8 * u@+ =: stored_signature_params =: stored_sign_commit_fee
stored_signature_params 4 u@+ =: stored_signature_params =: stored_min_stake_len
stored_signature_params stored_min_stake_len 8 * u@+ =: stored_signature_params =: stored_min_stake
stored_signature_params 3 u@+ =: stored_signature_params =: stored_provider_flags
stored_signature_params 8 u@+ =: stored_signature_params =: stored_provider_wc
stored_signature_params 256 u@+ =: stored_signature_params =: stored_provider_addr
stored_signature_params 1 u@+ =: stored_signature_params =: stored_dict_bits

// refs
stored_signature_params ref@+ =: stored_sign_request_code =: stored_signature_params
stored_signature_params s>

// assert contents

stored_sign_max_number 10 "Wrong stored_sign_max_number" ASSERT_EQUAL_INTS
stored_sign_number 0 "Wrong stored_sign_number" ASSERT_EQUAL_INTS
stored_sign_deploy_fee  500000000 "Wrong stored_sign_deploy_fee" ASSERT_EQUAL_INTS
stored_sign_commit_fee 1500000000 "Wrong stored_sign_commit_fee" ASSERT_EQUAL_INTS
stored_min_stake 9000000000 "Wrong stored_min_stake" ASSERT_EQUAL_INTS

<b b{100} s, stored_provider_wc 8 i, stored_provider_addr 256 u, b> boc>B  // stored provider
<b b{100} s, provider_wc 8 i, provider_addr 256 u, b> boc>B        // new provider
"Wrong bytes" ASSERT_EQUAL_BYTES

stored_dict_bits 0 "Wrong stored_dict_bits" ASSERT_EQUAL_INTS  // no signatures

stored_sign_request_code boc>B
sign_request_code s>c boc>B
"Wrong bytes" ASSERT_EQUAL_BYTES
